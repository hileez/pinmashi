function PromptModal(e,l,a,o){document.getElementById("promptModalLabel").innerHTML=e,document.getElementById("promptModalMessage").innerHTML=l,document.getElementById("promptModalValue").value=a,$("#promptModal").modal("show"),document.getElementById("promptModalOk").onclick=(()=>{o(document.getElementById("promptModalValue").value)}),document.getElementById("promptModalValue").onkeydown=(e=>{if(13==e.keyCode)return o(document.getElementById("promptModalValue").value),$("#promptModal").modal("hide"),!1})}function MultePromptModal(e,l,a){document.getElementById("multePromptModalLabel").innerHTML=e,document.getElementById("mainform").innerHTML="",l.forEach((e,o)=>{let t=`<div class="mb-3">\n                    <label for="recipient-name" class="col-form-label">${e.label}:</label>\n                    <input type="text" class="form-control" id="multePromptModalValue-${o}" value="${e.value}">\n                </div>`;document.getElementById("mainform").insertAdjacentHTML("beforeend",t),document.getElementById(`multePromptModalValue-${o}`).onkeydown=(e=>{if(13==e.keyCode){let e=[];return l.forEach((l,a)=>{e.push(document.getElementById("multePromptModalValue-"+a).value)}),a(e),$("#multePromptModal").modal("hide"),!1}})}),$("#multePromptModal").modal("show"),document.getElementById("multePromptModalOk").onclick=(()=>{let e=[];l.forEach((l,a)=>{e.push(document.getElementById("multePromptModalValue-"+a).value)}),a(e)})}function ConfirmModal(e,l,a=null){document.getElementById("confirmModalLabel").innerHTML=e,document.getElementById("confirmModalMessage").innerHTML=l,$("#confirmModal").modal("show"),document.getElementById("confirmModalOk").onclick=(()=>{a&&a()})}function AlertModal(e,l,a=null){document.getElementById("alertModalLabel").innerHTML=e,document.getElementById("alertModalMessage").innerHTML=l,$("#alertModal").modal("show"),document.getElementById("alertModalOk").onclick=(()=>{a&&a()})}function LoadModulesData(){let e=appIsPackaged?"resources/block_modules/modules.json":"./block_modules/modules.json";fsApi.readFile(e,"utf8",function(e,l){if(null==e){if(document.getElementById("card-list").innerHTML="",blocklyModules=JSON.parse(l.toString()),blocklyModules.forEach(e=>{let l=appIsPackaged?`../block_modules/${e.name}`:`./block_modules/${e.name}`,a=`<div class="col"><a class="card-link" href="javascript:CreateProject('${l}/${e.main}');">\n                                            <div class="card h-100"><img class="card-img-top w-100 d-block fit-cover" style="height: 200px;" src="${l}/img.jpg">\n                                                <div class="card-body p-4">\n                                                    <h4 class="card-title">${e.title}</h4>\n                                                    <p class="card-text">${e.description}</p>\n                                                    <div class="card-icon"><i class="fas fa-plus-circle"></i></div>\n                                                </div>\n                                            </div>\n                                        </a></div>`;document.getElementById("card-list").insertAdjacentHTML("beforeend",a)}),!publicData.project.module){let e=appIsPackaged?`../block_modules/${blocklyModules[0].name}/${blocklyModules[0].main}`:`./block_modules/${blocklyModules[0].name}/${blocklyModules[0].main}`;LoadWorkSpace(e)}}else console.log("readFile error:"+e)})}function CreateProject(e){$("#homeModal").modal("hide"),PromptModal("请输入","项目名称","",l=>{""!=l&&(publicData.project.name=l,publicData.project.filename="",publicData.project.isSave=0,ChangeTitle(),LoadWorkSpace(e))})}function LoadWorkSpace(e,l={}){publicData.module.debugCommand=null,blockApi.LoadModules(e,()=>{publicData.project.module=e,publicData.module.headCode=[],document.getElementById("blockly-workspace").innerHTML="",document.getElementById("textarea-code").value="",blocklyWorkspace=Blockly.inject("blockly-workspace",{media:"./assets/blockly/media/",toolbox:publicData.module.toolbox,sounds:!0,scrollbars:!0,trashcan:!1,zoom:{controls:!0,startScale:1,maxScale:3,minScale:.3,scaleSpeed:1.2,pinch:!0},grid:{spacing:20,length:1.2,colour:"#ccc",snap:!0},theme:Blockly.Themes.NewTheme}),Blockly.serialization.workspaces.load(l,blocklyWorkspace),blocklyWorkspace.addChangeListener(e=>{e.type==Blockly.Events.BLOCK_DELETE&&DelHeadCode();var l=Blockly.Python.workspaceToCode(blocklyWorkspace);let a="";publicData.module.headCode.forEach(e=>{a+=`${e.value}\n`}),l=a?`${a}\n${l}`:l,document.getElementById("textarea-code").value=l,myCodeMirror.setValue(l),publicData.project.isSave=0})})}function LoadProjectFile(){ipcRendererApi.send("showOpenDialog",""),ipcRendererApi.once("opendialog-callback",(e,l)=>{fsApi.readFile(l,"utf8",function(e,a){let o=JSON.parse(a),t=appIsPackaged?"resources/block_modules/modules.json":"./block_modules/modules.json";fsApi.readFile(t,"utf8",function(e,a){if(e)throw e;blocklyModules=JSON.parse(a.toString());let t=o.module.split("/"),c=t[t.length-2],n=!1;for(let e=0;e<blocklyModules.length;e++){let l=blocklyModules[e];if(l.name==c){n=!0;break}}n?(publicData.project.name=o.name,publicData.project.filename=l,publicData.project.isSave=1,LoadWorkSpace(o.module,o.workspaces),ChangeTitle()):AlertModal("提示",`缺少 ${c} 模块，无法打开项目，请导入该模块后再试！`)})})})}function SaveProjectFile(e){let l=e.split("\\"),a=l[l.length-1].replace(".pmsproj",""),o={name:a,module:publicData.project.module,workspaces:Blockly.serialization.workspaces.save(blocklyWorkspace)};fsApi.writeFile(e,JSON.stringify(o),l=>{null==l?(publicData.project.name=a,publicData.project.filename=e,publicData.project.isSave=1,ChangeTitle()):console.log("写入失败："+l)}),fsApi.writeFile(GetPyFileName(e),myCodeMirror.getValue(),e=>{})}function GetPyFileName(e){return e.substring(0,e.length-8)+".py"}function ChangeTitle(){let e=publicData.project.name;e+=publicData.device.host?` - 已连接${publicData.device.host}设备`:"",e+=" - PinMaShi",document.title=e}function AddHeadCode(e,l,a,o=0){let t=publicData.module.headCode.every(o=>o.name!=e||(o.types.indexOf(a)<0&&(o.types.push(a),o.value=l),!1));t&&(o?publicData.module.headCode.unshift({name:e,value:l,types:[a]}):publicData.module.headCode.push({name:e,value:l,types:[a]}))}function DelHeadCode(){for(let e=0;e<publicData.module.headCode.length;e++){let l=publicData.module.headCode[e];for(let e=0;e<l.types.length;e++){let a=l.types[e];a in blocklyWorkspace.typedBlocksDB_||(l.types.splice(e,1),e--)}l.types.length||(publicData.module.headCode.splice(e,1),e--)}}let appIsPackaged=ipcRendererApi.sendSync("app-IsPackaged","");ipcRendererApi.on("event-relay",(e,l)=>{ipcRendererApi.send(l)});let publicData={project:{name:"",module:"",filename:"",isSave:0},device:{host:"",isShell:0},module:{toolbox:null,debugCommand:null,headCode:[]}},blocklyWorkspace=null;publicData.project.name="demo",publicData.project.filename="",publicData.project.isSave=0,ChangeTitle(),LoadModulesData(),ipcRendererApi.on("load-modules-data",(e,l)=>{LoadModulesData()});var myCodeMirror=CodeMirror.fromTextArea(document.getElementById("textarea-code"),{mode:"python",keyMap:"sublime",lineNumbers:!0,smartIndent:!0,indentUnit:4,indentWithTabs:!0,lineWrapping:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],foldGutter:!0,autofocus:!0,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0});myCodeMirror.on("keypress",function(){myCodeMirror.showHint()}),Blockly.Themes.NewTheme=Blockly.Theme.defineTheme("halloween",{base:Blockly.Themes.Classic,componentStyles:{workspaceBackgroundColour:"#ffffff",toolboxBackgroundColour:"#f5f5f5",toolboxForegroundColour:"#969696",flyoutBackgroundColour:"#e9e9ee",flyoutForegroundColour:"#0000ff",flyoutOpacity:.8,scrollbarColour:"#dadada",insertionMarkerColour:"#fff",insertionMarkerOpacity:.3,scrollbarOpacity:.4,cursorColour:"#d0d0d0",blackBackground:"#333"}}),Blockly.prompt=((e,l,a)=>{PromptModal("请输入",e,l,e=>{e&&a(e)})}),ipcRendererApi.on("new-project",(e,l)=>{0==publicData.project.isSave?ConfirmModal("提示","当前项目未保存，确定要新建项目吗？",()=>{$("#homeModal").modal("show")}):$("#homeModal").modal("show")}),ipcRendererApi.on("open-project",(e,l)=>{0==publicData.project.isSave?ConfirmModal("提示","当前项目未保存，确定要打开项目吗？",()=>{LoadProjectFile()}):LoadProjectFile()}),ipcRendererApi.on("save-project",(e,l)=>{""==publicData.project.filename?(ipcRendererApi.send("showSaveDialog",publicData.project.name),ipcRendererApi.once("savedialog-callback",(e,l)=>{l&&SaveProjectFile(l)})):SaveProjectFile(publicData.project.filename)}),ipcRendererApi.on("save-project-as",(e,l)=>{ipcRendererApi.send("showSaveDialog",publicData.project.name),ipcRendererApi.once("savedialog-callback",(e,l)=>{l&&SaveProjectFile(l)})}),ipcRendererApi.on("rename-project",(e,l)=>{PromptModal("请输入","项目名称",publicData.project.name,e=>{e&&(publicData.project.filename&&(fsApi.unlink(publicData.project.filename,()=>{}),fsApi.unlink(GetPyFileName(publicData.project.filename),()=>{}),publicData.project.filename=publicData.project.filename.replace(`${publicData.project.name}.pmsproj`,`${e}.pmsproj`),SaveProjectFile(publicData.project.filename)),publicData.project.name=e,ChangeTitle())})}),ipcRendererApi.on("exit-program",(e,l)=>{0==publicData.project.isSave?ConfirmModal("提示","当前项目未保存，确定要退出程序吗？",()=>{ipcRendererApi.send("app-quit")}):ConfirmModal("提示","确定要退出程序吗？",()=>{ipcRendererApi.send("app-quit")})}),ipcRendererApi.on("device-connect",(e,l)=>{MultePromptModal("连接设备",[{label:"设备IP",value:""},{label:"用户名",value:"robot"},{label:"密码",value:"maker"},{label:"端口（默认是22）",value:"22"}],e=>{if(e){let l=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;l.test(e[0])?(publicData.device.host=e[0],ipcRendererApi.send("device-connect",{host:e[0],port:e[3],username:e[1],password:e[2]})):AlertModal("提示","IP输入错误，请重新输入！",()=>{ipcRendererApi.send("resend-renderer","device-connect")})}})}),ipcRendererApi.on("run-local",(e,l)=>{""==publicData.project.filename?(ipcRendererApi.send("showSaveDialog",publicData.project.name),ipcRendererApi.once("savedialog-callback",(e,l)=>{l&&(SaveProjectFile(l),ipcRendererApi.send("local-python-run",{debugCommand:publicData.module.debugCommand,filename:GetPyFileName(l)}))})):(SaveProjectFile(publicData.project.filename),ipcRendererApi.send("local-python-run",{debugCommand:publicData.module.debugCommand,filename:GetPyFileName(publicData.project.filename)}))}),ipcRendererApi.on("run-device",(e,l)=>{publicData.device.host?publicData.device.isShell||(""==publicData.project.filename?(ipcRendererApi.send("showSaveDialog",publicData.project.name),ipcRendererApi.once("savedialog-callback",(e,l)=>{l&&(SaveProjectFile(l),ipcRendererApi.send("device-python-run",{debugCommand:publicData.module.debugCommand,filename:GetPyFileName(l)}),publicData.device.isShell=1)})):(SaveProjectFile(publicData.project.filename),ipcRendererApi.send("device-python-run",{debugCommand:publicData.module.debugCommand,filename:GetPyFileName(publicData.project.filename)}),publicData.device.isShell=1),outputData=[],document.getElementById("output-shell").value=""):ConfirmModal("提示","未连接设备无法调试，确定要连接设备吗？",()=>{ipcRendererApi.send("resend-renderer","device-connect")})}),ipcRendererApi.on("clear-console",(e,l)=>{outputData=[],document.getElementById("output-shell").value=""}),ipcRendererApi.on("new-bash",(e,l)=>{ipcRendererApi.send("local-create-shell")}),document.getElementById("input-shell").onkeydown=(e=>{if(13==e.keyCode){let e=document.getElementById("input-shell");ipcRendererApi.send("device-shell-write",e.value),e.value=""}}),ipcRendererApi.on("device-reply",(e,l)=>{switch(l){case"success":l="设备已连接\n",publicData.device.isShell=0,ChangeTitle();break;case"error":l="设备连接错误\n",publicData.device.host="",publicData.device.isShell=0,ChangeTitle();break;case"end":l="设备连接结束\n",publicData.device.host="",publicData.device.isShell=0,ChangeTitle();break;case"close":l="设备已关闭\n",publicData.device.host="",publicData.device.isShell=0,ChangeTitle();break;case"shell_created":l="设备开始调试\n",publicData.device.isShell=1;break;case"shell_closed":l="设备停止调试\n",publicData.device.isShell=0}outputData.push(l)});let outputData=[];setInterval(()=>{let e=outputData.length;if(e){data=outputData.join("");let l=document.getElementById("output-shell");l.value=data,l.scrollTop=l.scrollHeight,e>50&&(outputData=[])}},100);