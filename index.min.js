function createWindow(){mainWindow=new BrowserWindow({width:1280,minWidth:1280,height:860,minHeight:860,webPreferences:{preload:path.join(__dirname,"preload.js"),sandbox:!1}}),mainWindow.loadFile("./assets/pages/home.html"),!app.isPackaged&&mainWindow.webContents.openDevTools()}function ImportBlockModule(e,n=null){compressing.zip.uncompress(e,"./temp").then(()=>{let o=app.isPackaged?"resources/block_modules/modules.json":"./block_modules/modules.json";fs.readFile(o,"utf8",(t,i)=>{let c=JSON.parse(fs.readFileSync("./temp/module.json","utf8")),l=JSON.parse(i),a=!1;for(let e=0;e<l.length;e++){let n=l[e];if(n.name==c.name){a=!0;break}}if(a)n&&n("module exist");else{let t=app.isPackaged?`resources/block_modules/${c.name}`:`./block_modules/${c.name}`;fs.mkdir(t,i=>{compressing.zip.uncompress(e,t).then(()=>{l.push(c),fs.writeFile(o,JSON.stringify(l),e=>{n&&n("")})}).catch(()=>{console.log("è§£åŽ‹å¤±è´¥")})})}})}).catch(()=>{console.log("è§£åŽ‹å¤±è´¥")})}function OpenBlockModule(){dialog.showOpenDialog(mainWindow,{title:"å¯¼å…¥æ¨¡å—",filters:[{name:"Module",extensions:["pbmd"]}],properties:["openFile"]}).then(e=>{e.filePaths.length>0&&ImportBlockModule(e.filePaths[0],e=>{let n="";e?n="æ¨¡å—å€’å…¥å¤±è´¥":(mainWindow.webContents.send("load-modules-data"),n="æ¨¡å—å€’å…¥æˆåŠŸ"),dialog.showMessageBox(mainWindow,{type:"warning",title:"æç¤º",message:n,buttons:["ç¡®å®š"]}).then(e=>{})})}).catch(e=>{console.log(e)})}function UpdateCheck(){let e="https://gitee.com/supercoderlee/pinmashi/releases";https.get(e,e=>{let n="";e.on("data",e=>{n+=e}),e.on("end",()=>{var e=cheerio.load(n),o=e(".tag-name").attr("data-tag-name");console.log(o),"v1.0.0"==o?dialog.showMessageBox(mainWindow,{type:"info",title:"æç¤º",message:`å½“å‰ ${o} ä¸ºæœ€æ–°ç‰ˆæœ¬`,buttons:["ç¡®å®š"]}).then(e=>{}):setTimeout(()=>{dialog.showMessageBox(mainWindow,{type:"info",title:"æç¤º",message:`è¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ ${o}`,buttons:["ç¡®å®š"]}).then(e=>{exec("start https://github.com/supercoderlee/pinmashi/releases")})},1e3)})}).on("error",e=>{setTimeout(()=>{dialog.showMessageBox(mainWindow,{type:"info",title:"æç¤º",message:"ç½‘ç»œæ— æ³•è¿žæŽ¥",buttons:["ç¡®å®š"]}).then(e=>{})},1e3)})}const{app:app,BrowserWindow:BrowserWindow,ipcMain:ipcMain,dialog:dialog,Menu:Menu,MenuItem:MenuItem}=require("electron"),path=require("path"),{spawn:spawn,exec:exec}=require("child_process");let mainWindow;const template=[{label:"æ–‡ä»¶",submenu:[{label:"æ–°å»ºé¡¹ç›®",accelerator:(process.platform,"Ctrl+N"),click:()=>{mainWindow.webContents.send("new-project")}},{label:"æ‰“å¼€é¡¹ç›®",accelerator:(process.platform,"Ctrl+O"),click:()=>{mainWindow.webContents.send("open-project")}},{label:"ä¿å­˜",accelerator:(process.platform,"Ctrl+S"),click:()=>{mainWindow.webContents.send("save-project")}},{label:"å¦å­˜ä¸ºâ€¦",accelerator:(process.platform,"Ctrl+Shift+S"),click:()=>{mainWindow.webContents.send("save-project-as")}},{label:"å¯¼å…¥æ¨¡å—",accelerator:(process.platform,"Ctrl+Shift+I"),click:()=>{mainWindow.webContents.send("event-relay","import-module"),ipcMain.on("import-module",function(e,n){OpenBlockModule()})}},{label:"é‡å‘½åé¡¹ç›®",accelerator:(process.platform,"Ctrl+R"),click:()=>{mainWindow.webContents.send("rename-project")}},{label:"é€€å‡º",click:()=>{mainWindow.webContents.send("exit-program")}}]},{label:"è®¾å¤‡",submenu:[{label:"è¿žæŽ¥",accelerator:(process.platform,"Ctrl+Shift+L"),click:()=>{mainWindow.webContents.send("device-connect")}},{label:"æ–­å¼€",accelerator:(process.platform,"Ctrl+Shift+E"),click:()=>{mainWindow.webContents.send("event-relay","conn-end"),ipcMain.on("conn-end",function(e,n){conn.end()})}}]},{label:"è¿è¡Œ",submenu:[{label:"æœ¬åœ°è°ƒè¯•",accelerator:(process.platform,"F5"),click:()=>{mainWindow.webContents.send("run-local")}},{label:"è®¾å¤‡è°ƒè¯•",accelerator:(process.platform,"F6"),click:()=>{mainWindow.webContents.send("run-device")}},{label:"å…³é—­è°ƒè¯•",accelerator:(process.platform,"F7"),click:()=>{mainWindow.webContents.send("event-relay","device-debug-end"),ipcMain.on("device-debug-end",function(e,n){connected.pids&&connected.sftp&&device.DebugEnd(conn)})}},{label:"æ¸…é™¤è°ƒè¯•æŽ§åˆ¶å°",accelerator:"darwin"===process.platform?"Alt+Cmd+C":"Alt+Shift+C",click:()=>{mainWindow.webContents.send("clear-console")}}]},{label:"ç»ˆç«¯",submenu:[{label:"æ–°å»ºç»ˆç«¯",accelerator:(process.platform,"Ctrl+Shift+B"),click:()=>{mainWindow.webContents.send("new-bash")}}]},{label:"å¸®åŠ©",submenu:[{label:"åŠ å…¥äº¤æµå­¦ä¹ QQç¾¤",click:()=>{dialog.showMessageBox(mainWindow,{type:"info",title:"æç¤º",message:"è½¯ä»¶ä½¿ç”¨äº¤æµç¾¤ã€ç¼–ç¨‹å­¦ä¹ äº¤æµç¾¤ï¼š647165120",buttons:["ç¡®å®š"]}).then(e=>{})}},{label:"å®˜æ–¹Github",click:()=>{exec("start https://github.com/supercoderlee/pinmashi")}},{label:"æ¨¡å—ä¸‹è½½",click:()=>{exec("start https://github.com/supercoderlee/pinmashi-resources")}},{label:"æ£€æŸ¥æ›´æ–°â€¦",click:()=>{UpdateCheck()}},{label:"å…³äºŽ",click:()=>{dialog.showMessageBox(mainWindow,{type:"info",title:"æç¤º",message:"è½¯ä»¶ç‰ˆæœ¬ï¼š1.0.0\nè½¯ä»¶ç‰ˆæƒï¼šæœ¬è½¯ä»¶ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œè½¯ä»¶ä»…ä¾›å­¦ä¹ ä½¿ç”¨ç¦æ­¢ä»»ä½•äººæˆ–ç»„ç»‡æœºæž„ç”¨ä½œå•†ä¸šç”¨é€”ã€‚\nè½¯ä»¶ç®€ä»‹ï¼šæœ¬è½¯ä»¶æ˜¯ä¸ºæ™ºèƒ½è®¾å¤‡ç¼–ç¨‹ç ”å‘çš„ç¨‹åºç¼–è¾‘å™¨ï¼Œé‡‡ç”¨å¯è§†åŒ–æ‹–æ‹½å¼ç§¯æœ¨ç¼–ç¨‹ï¼Œæœ‰æ•ˆé™ä½Žç¼–ç¨‹éš¾åº¦ä¸”èƒ½æ›´ç›´è§‚ç†è§£ç¨‹åºé€»è¾‘ã€‚è½¯ä»¶ä¸»è¦ç”¨åœ¨åŸºäºŽLinuxæ“ä½œç³»ç»Ÿçš„æ™ºèƒ½è®¾å¤‡è¿œç¨‹ç¨‹åºå¼€å‘å’Œè°ƒè¯•ã€‚\nå¦å¤–è½¯ä»¶è¿˜ç»“åˆç‰©è”ç½‘å¼€å‘å®žçŽ°ä¸Šä½æœºå’Œä¸‹ä½æœºçš„ç¨‹åºå¼€å‘ï¼Œå®žçŽ°ç‰©è”ç½‘è®¾å¤‡äº’è”äº’é€šã€‚",buttons:["ç¡®å®š"]}).then(e=>{})}}]}];Menu.setApplicationMenu(Menu.buildFromTemplate(template)),app.whenReady().then(()=>{createWindow(),app.on("activate",function(){0===BrowserWindow.getAllWindows().length&&createWindow()})}),app.on("window-all-closed",function(){"darwin"!==process.platform&&app.quit(),mainWindow=null});const fs=require("fs"),compressing=require("compressing");ipcMain.on("app-IsPackaged",function(e,n){e.returnValue=app.isPackaged}),ipcMain.on("app-quit",function(e,n){app.quit()}),ipcMain.on("resend-renderer",function(e,n){e.sender.send(n)}),ipcMain.on("app-path",function(e,n){e.returnValue=app.getAppPath()}),ipcMain.on("showOpenDialog",function(e,n){dialog.showOpenDialog(mainWindow,{title:"æ‰“å¼€æ–‡ä»¶",filters:[{name:"pms-project",extensions:["pmsproj"]}],properties:["openFile"]}).then(n=>{n.filePaths.length>0&&e.sender.send("opendialog-callback",n.filePaths[0])}).catch(e=>{console.log(e)})}),ipcMain.on("showSaveDialog",function(e,n){dialog.showSaveDialog(mainWindow,{title:"ä¿å­˜æ–‡ä»¶",defaultPath:n,filters:[{name:"pms-project",extensions:["pmsproj"]}],properties:["openFile"]}).then(n=>{n.filePath?e.sender.send("savedialog-callback",n.filePath):e.sender.send("savedialog-callback","")}).catch(e=>{console.log(e)})}),ipcMain.on("local-python-run",function(e,n){if("linux"==process.platform||"darwin"==process.platform){spawn("bash",{detached:!0})}else if("win32"==process.platform){let e="cmd /K python ";e+=n.debugCommand?n.debugCommand+" ":"",e+=n.filename+"\n";spawn(e,{shell:!0,detached:!0})}}),ipcMain.on("local-create-shell",function(e,n){if("linux"==process.platform||"darwin"==process.platform);else if("win32"==process.platform){spawn("cmd",{shell:!0,detached:!0})}}),ipcMain.on("open-link",(e,n)=>{exec(`start ${n}`)});const{Client:Client}=require("ssh2"),conn=new Client;connected={host:null,port:null,username:null,password:null,sftp:null,stream:null,pids:[]},conn.on("ready",()=>{console.log("Client :: ready"),mainWindow.webContents.send("device-reply","success"),conn.sftp((e,n)=>{if(e)throw e;connected.sftp=n})}),conn.on("error",e=>{console.log("Connection :: error :: "+e),connected.sftp=null,connected.stream=null,connected.pids=[],conn.end(),mainWindow&&mainWindow.webContents.send("device-reply","error")}),conn.on("end",()=>{console.log("Connection :: end"),connected.sftp=null,connected.stream=null,connected.pids=[],mainWindow&&mainWindow.webContents.send("device-reply","end")}),conn.on("close",e=>{console.log("Connection :: close"),connected.sftp=null,connected.stream=null,connected.pids=[],mainWindow&&mainWindow.webContents.send("device-reply","close")}),ipcMain.on("device-connect",function(e,n){connected.sftp&&conn.end(),conn.connect(n),connected.host=n.host,connected.port=n.port,connected.username=n.username,connected.password=n.password}),ipcMain.on("device-close",function(e,n){conn.end()});const device=require("./addons/device");ipcMain.on("device-python-run",function(e,n){if(connected.sftp){let o=n.filename.split("\\"),t=o[o.length-1],i={};i.userdir=`/home/${connected.username}`,i.exedirname="ev3-block",i.executable=`${i.userdir}/${i.exedirname}/${t}`,connected.sftp.readdir(i.userdir,(o,t)=>{if(o)throw o;let c=!1;for(let e=0;e<t.length;e++){let n=t[e];if(n.filename==i.exedirname&&"d"==n.longname.substring(0,1)){c=!0;break}}c?connected.sftp.fastPut(n.filename,i.executable,o=>{if(o)throw o;device.Debug(conn,e,n.debugCommand,i.executable)}):connected.sftp.mkdir(`${i.userdir}/${i.exedirname}`,o=>{if(o)throw o;connected.sftp.fastPut(n.filename,i.executable,o=>{if(o)throw o;device.Debug(conn,e,n.debugCommand,i.executable)})})})}}),ipcMain.on("device-shell-write",function(e,n){connected.stream&&connected.stream.write(`${n}\n`)}),ipcMain.on("device-shell-close",function(e,n){connected.pids&&connected.sftp&&device.DebugEnd(conn)}),OutputFilter=function(e){return e=e.indexOf("chmod")>-1?"":e,e=e.indexOf("cd")>-1?"":e,e=e.indexOf("Last login")>-1?"":e,e=e.indexOf("###")>-1?"":e,e=e.indexOf(`${connected.username}@`)>-1?"":e,e=e.replace("[?2004l",""),e=e.replace("[?2004h",""),e};const https=require("https"),cheerio=require("cheerio");